name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Configure Git line endings
      if: runner.os == 'Windows'
      run: |
        git config --global core.autocrlf false
        git config --global core.eol lf

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Fix line endings on Windows
      if: runner.os == 'Windows'
      run: |
        npx prettier --write . --loglevel error
        
    - name: Run linting
      run: npm run lint

    - name: Run type checking
      run: npx tsc --noEmit

    - name: Run unit tests
      run: npm run test:unit
      continue-on-error: true

    - name: Setup Xvfb for VS Code tests (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb

    - name: Run VS Code extension tests (Linux with Xvfb)
      if: runner.os == 'Linux'
      run: xvfb-run -a npm run test:integration
      continue-on-error: true

    - name: Run VS Code extension tests (Windows/macOS)
      if: runner.os != 'Linux'
      run: npm run test:integration
      continue-on-error: true

  build:
    name: Build Extension
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build extension
      run: npm run vscode:prepublish

    - name: Package extension
      run: npm run package

    - name: Upload VSIX artifact
      uses: actions/upload-artifact@v4
      with:
        name: executable-talk-vsix
        path: '*.vsix'

  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit --audit-level moderate
      continue-on-error: true

  release:
    name: Release Extension
    runs-on: ubuntu-latest
    needs: [build, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Download VSIX artifact
      uses: actions/download-artifact@v4
      with:
        name: executable-talk-vsix

    - name: Configure Git for version bumping
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

    - name: Auto version bump (patch)
      if: "contains(github.event.head_commit.message, '[version:patch]')"
      id: version_patch
      run: |
        npm run version:patch
        NEW_VERSION=$(node -p "require('./package.json').version")
        echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
        git add package.json package-lock.json
        git commit -m "chore: bump version to ${NEW_VERSION} [skip ci]"
        git tag "v${NEW_VERSION}"
        git push origin main --tags

    - name: Auto version bump (minor)  
      if: "contains(github.event.head_commit.message, '[version:minor]')"
      id: version_minor
      run: |
        npm run version:minor
        NEW_VERSION=$(node -p "require('./package.json').version")
        echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
        git add package.json package-lock.json
        git commit -m "chore: bump version to ${NEW_VERSION} [skip ci]"
        git tag "v${NEW_VERSION}"
        git push origin main --tags

    - name: Auto version bump (major)
      if: "contains(github.event.head_commit.message, '[version:major]')"
      id: version_major
      run: |
        npm run version:major
        NEW_VERSION=$(node -p "require('./package.json').version")
        echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
        git add package.json package-lock.json
        git commit -m "chore: bump version to ${NEW_VERSION} [skip ci]"
        git tag "v${NEW_VERSION}"
        git push origin main --tags

    - name: Rebuild VSIX with new version
      if: contains(github.event.head_commit.message, '[version:')
      run: |
        npm run compile
        npm run package

    - name: Create GitHub Release
      if: contains(github.event.head_commit.message, '[version:')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version_patch.outputs.new_version || steps.version_minor.outputs.new_version || steps.version_major.outputs.new_version }}
        files: '*.vsix'
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Publish to VS Code Marketplace
      if: contains(github.event.head_commit.message, '[version:')
      env:
        VSCE_PAT: ${{ secrets.VSCE_PAT }}
      run: |
        if [ -n "$VSCE_PAT" ]; then
          npx vsce publish -p $VSCE_PAT
        else
          echo "Skipping VS Code Marketplace publish - VSCE_PAT not configured"
        fi
